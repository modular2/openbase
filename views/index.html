<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>modular-2</title>
  <link href="/home/css/bootstrap.min.css" rel="stylesheet">
  <link href="/home/css/default.css" rel="stylesheet">
  <link href="/home/css/font-awesome.min.css" rel="stylesheet">
  <script src="/home/js/jquery-3.4.1.min.js"></script>
   <script src="/home/js/bootstrap.min.js"></script>
  
   <script>
  var outgoing_id=0;
    function get_outgoing_id()
    {
      outgoing_id++;
      if (outgoing_id>5000) outgoing_id=0;
      return outgoing_id;
    }
	 $( document ).ready(function() {
    window.restbed = { ws: null };
    openIOsocket();  	 
})
function openIOsocket( )
      {
         if ( "WebSocket" in window )
         {
            var ws = new WebSocket( "ws://192.168.31.98:2019/iosocket/0234" );
            ws.binaryType = "arraybuffer";
            ws.onopen = function( )
            {
              // add_message( "Established connection." );
             setInterval(function(){
               if (window.restbed.ws.readyState  == window.restbed.ws.OPEN)
              {
                var jsonrpc={
                  "method":"ping",
                  "id": 0
                }
                  window.restbed.ws.send(JSON.stringify(jsonrpc));
             }
             },1500);
              // toggle_control_access( );
            };

            ws.onmessage = function( evt )
            {
              //add_message( evt.data );
           var eventMessage  = new Uint8Array(evt.data);
            var s = new TextDecoder("utf-8").decode(eventMessage);
          
           var messageBody=JSON.parse(s);
        // console.log(messageBody);
           if ("method" in messageBody)
            {               
                        if (messageBody.method=="welcome")  
                        { 
                        console.log("ws connected");
                        getApplist();
                        }

            };            
           if ("result" in messageBody)
           {        
                    var  result=messageBody.result;
                 //  console.log(messageBody);
                    if (result.status=="err")
                    {
                      
                      console.log("error with Code: "+result.value[0]);
                    }
           
              if (result.status=="get.applist")
              {
                appInsert(result.value);
              }
              if (result.status=="OK")
              {
                 measurment();
                if ("value" in result)
               $("#result").html("600+2="+result.value[0]);
              }
           } 
            }
            ws.onclose = function( evt )
            {
           console.log("connection closed with Code:"+evt.code);
               //toggle_control_access( );
            };

            ws.onerror = function( evt )
            {
              // add_message( "Error: socket connection interrupted." );
            };

            window.restbed.ws = ws;
         }
         else
         {
            alert( "WebSockets NOT supported by your Browser!" );
         }
      }
function getApplist()
{
  var path="000/000/000";
  var id=get_outgoing_id();
  var jsonrpc={
  "method":"get.applist",
  "mode":1,
  "path":path,
  "params":{"value":[0]},
  "id": id
 }
    console.log(jsonrpc);
      window.restbed.ws.send(JSON.stringify(jsonrpc));
   
}	
function appInsert(applist)
{ var index=0;
  applist.forEach(element => {
    index=index+1;
var template='<div class="col-xs-4 col-md-3" id="item'+index+'"></div>';
    $('#container_body').append(template);
    template='<a href="http://localhost:'+element["port"]+'/views/'+element["name"]+'.html" class="thumbnail" id="item'+index+'0">';
    $('#item'+index).append(template);
    template='<div class="col-xs-4 col-md-3" id="item'+index+'0"></div>';
    $('#item'+index+'0').append(template);
    template='<img src="http://localhost:'+element["port"]+'/images/logo.png" class="mx-auto d-block"   alt="MQTT">';
    $('#item'+index+'0').append(template);
    template=' <div class = "text-center">'+element["name"]+'</div>';
    $('#item'+index+'0').append(template);
  });
}
 
   </script>
  </head>
  
 <body >
   <!-- Image and text -->
   <nav class="navbar fixed-top  navbar-default ">
      <a class="nav-link" href="#"><i class="icon-home icon-2x "> </i>主页</a>
      <a class="navbar-brand" href="#">modular-2 Edge</a>
      <a class="nav-link  pull-right" href="/home/views/system_setup.html"><i class="icon-cogs icon-2x"> </i>设置</a>
    </nav>
   
<div class="row" id="container_body">
<div class="col-xs-4 col-md-3" id="item_0">
<a href="/home/views/dashboard.html" class="thumbnail" id="item_00">
<img src="/home/images/setting.png" class="mx-auto d-block"   alt="MQTT">
 <div class = "text-center">dashboard</div>
</a>
</div>
</div>
</div>

  </body>
  </html>